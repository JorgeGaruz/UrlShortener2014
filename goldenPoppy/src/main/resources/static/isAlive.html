<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Url is Alive?</title>
    <script type="text/javascript" src="webjars/stomp-websocket/2.3.1-1/stomp.js"></script>
	<script type="text/javascript" src="webjars/sockjs-client/0.3.4-1/sockjs.js"></script>
    <script type="text/javascript">
        var stompClient = null;

        function connect() {
            var socket = new SockJS('/isalive');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function(frame) {
                console.log('Connected: ' + frame);
                stompClient.subscribe('/topic/isalive', function(response){
                    showResponse(JSON.parse(response.body).status);
                });
            });
        }

        function disconnect() {
            stompClient.disconnect();
            console.log("Disconnected");
        }

        function sendUrl(timeout) {
            var url = document.getElementById('url').value;
            stompClient.send("/app/isalive", {}, JSON.stringify({ 'url': url , 'timeout' : timeout }));
        }

        function showResponse(message) {
            var response = document.getElementById('response');
            var p = document.createElement('p');
            p.style.wordWrap = 'break-word';
			if (message == 1){
				p.appendChild(document.createTextNode("La url está viva"));
				response.appendChild(p);
			}
			else if ( message == -1){
				p.appendChild(document.createTextNode("La url NO está viva"));
				response.appendChild(p);
			}
			else{ // Es 0 (TIMEOUT)
				if (confirm("Le está costando responder... ¿Quieres intentarlo con más tiempo?")){
					var t = prompt("Pon un timeout (segundos)", "10");
					if (t != null){
						var num = parseInt(t);
						if (!isNaN(num)){
							if (num < 2 || num > 30){
								alert("Error. 2 < timeout < 30");
							}
							else{ // Todo OK
								var url = document.getElementById('url').value;
								// volver a enviar la peticion con otro timeout
								sendUrl(num);
							}			
						}
						else{
							alert("Error. Debes introducir un número");
						}		
					}
					else{
						alert("Error. No puedes dejarlo vacío");
					}
				}
			}   
        }
    </script>
</head>
<body onload="connect()" onunload="disconnect()">
<noscript>&lt;h2 style="color: #ff0000"&gt;Seems your browser doesn't support Javascript! Websocket relies on Javascript being enabled. Please enable
    Javascript and reload this page!&lt;/h2&gt;</noscript>
<div>
    <div id="conversationDiv">
        <label>Enter a URL</label><input type="text" id="url">
        <button id="sendUrl" onclick="sendUrl(2);">Send</button>
        <p id="response"></p>
    </div>
</div>


</body></html>
